<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>8チーム・3位決定戦つきトーナメント表</title>
  <style>
    :root {
      --bg:#0b1020;           /* 濃紺の背景 */
      --card:#121a33;         /* カード背景 */
      --muted:#7c8db0;        /* 補助テキスト */
      --text:#e9efff;         /* 文字色 */
      --accent:#5ad1ff;       /* アクセント */
      --win:#3bd671;          /* 勝者カラー */
      --line:#3b4b7a;         /* 接続線 */
      --gap:28px;             /* ラウンド横間隔 */
      --match-h:84px;         /* 1試合カードの高さ */
      --radius:14px;
      --shadow:0 6px 16px rgba(0,0,0,.25);
    }

    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin:0; background:linear-gradient(160deg, #0a0f20, #0e1430 60%, #0a0f20);
      color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
    }

    header {
      padding:24px 20px 10px; max-width:1200px; margin:0 auto; display:flex; gap:16px; align-items:end; flex-wrap:wrap;
    }
    header h1 { margin:0; font-size:clamp(18px,4vw,28px); letter-spacing:.5px; }
    header .sub { color:var(--muted); font-size:12px; }

    .panel {
      max-width:1200px; margin:0 auto; padding:12px 20px 0; display:grid; gap:12px;
      grid-template-columns: 1fr 3fr; align-items:start;
    }

    .controls { background:rgba(18,26,51,.6); border:1px solid #1f2a4a; border-radius:16px; padding:14px; backdrop-filter: blur(6px); box-shadow: var(--shadow); }
    .controls h2 { font-size:16px; margin:0 0 8px; }
    .seed-grid { display:grid; grid-template-columns: 28px 1fr; gap:8px 10px; align-items:center; }
    .seed-grid label { color:var(--muted); font-size:12px; text-align:right; }
    .seed-grid input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #22305c; background:#0f1630; color:var(--text); outline:none; }
    .seed-grid input::placeholder{ color:#586a96; }

    .btns { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button.btn { border:1px solid #26406b; background:#162043; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow: var(--shadow); }
    button.btn:hover { filter:brightness(1.1); }
    button.btn:active { transform: translateY(1px); }

    .legend { font-size:12px; color:var(--muted); margin-top:6px; line-height:1.6; }

    /* ===== Bracket ===== */
    .stage { position:relative; max-width:1200px; margin:8px auto 40px; padding:24px 20px; background:rgba(7,12,28,.35); border:1px solid #1a2649; border-radius:18px; box-shadow: var(--shadow); }

    .bracket { position:relative; display:grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap: var(--gap); align-items: center; }

    .round { display:grid; grid-auto-rows: var(--match-h); row-gap: calc(var(--match-h)); }
    .round h3 { margin:0 0 10px; font-size:14px; color:#9eb2dc; letter-spacing:.5px; }

    .match { position:relative; background:var(--card); border:1px solid #2a396b; border-radius: var(--radius); padding:8px; display:grid; gap:8px; box-shadow: var(--shadow); }
    .match .game-id { position:absolute; top:-10px; left:10px; background:#0e1533; color:#9eb2dc; border:1px solid #283968; padding:2px 8px; border-radius:999px; font-size:11px; }

    .team-btn { display:flex; align-items:center; justify-content:space-between; gap:10px; width:100%; height:34px; padding:0 10px; border:1px solid #2a396b; border-radius:10px; background:#0e1533; color:var(--text); cursor:pointer; font-weight:600; box-shadow: inset 0 0 0 1px rgba(255,255,255,.02); }
    .team-btn .seed { opacity:.75; font-size:12px; }
    .team-btn .name { flex:1; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .team-btn.winner { background: linear-gradient(180deg, #103b28, #0c2216); border-color:#245a3f; box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 0 0 2px rgba(59,214,113,.15); }
    .team-btn.winner .name { color:#d8ffe7; }

    .result { margin-top:18px; display:flex; gap:12px; flex-wrap:wrap; }
    .result .pill { border:1px solid #2a396b; padding:8px 12px; border-radius:999px; background:#0e1533; color:#cfe0ff; font-weight:700; }

    /* SVG lines overlay */
    svg#lines { position:absolute; inset:0; pointer-events:none; }
    svg#lines path { stroke: var(--line); stroke-width: 2.5; fill: transparent; }

    /* Responsive tweaks */
    @media (max-width: 980px) {
      .panel { grid-template-columns: 1fr; }
      .bracket { grid-template-columns: 1fr; }
      .round { row-gap: 18px; }
      .legend { font-size:11px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>8チーム・シングルエリミネーション（3位決定戦あり）</h1>
      <div class="sub">準々決勝4試合 / 準決勝2試合 / 決勝1試合 / 3位決定戦1試合 = 合計8試合</div>
    </div>
  </header>

  <section class="panel">
    <div class="controls">
      <h2>参加チーム（シード順）</h2>
      <div class="seed-grid" id="seedInputs">
        <!-- 動的に入力を生成 -->
      </div>
      <div class="btns">
        <button class="btn" id="applySeeds">この8チームでセット</button>
        <button class="btn" id="shuffleSeeds">ランダム並び替え</button>
        <button class="btn" id="resetAll">全リセット</button>
      </div>
      <div class="legend">
        ・カード内のチーム名をクリックで勝者確定（次ラウンドへ自動反映）<br>
        ・<b>Shift + クリック</b>でその試合の勝者を取り消し（以降の自動反映もクリア）
      </div>
    </div>

    <div class="stage">
      <div class="bracket" id="bracket">
        <svg id="lines"></svg>

        <div class="round" data-round="1">
          <h3>準々決勝</h3>
          <div class="match" data-id="QF1">
            <span class="game-id">QF1</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
          <div class="match" data-id="QF2">
            <span class="game-id">QF2</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
          <div class="match" data-id="QF3">
            <span class="game-id">QF3</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
          <div class="match" data-id="QF4">
            <span class="game-id">QF4</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
        </div>

        <div class="round" data-round="2">
          <h3>準決勝</h3>
          <div class="match" data-id="SF1">
            <span class="game-id">SF1</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
          <div class="match" data-id="SF2">
            <span class="game-id">SF2</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
        </div>

        <div class="round" data-round="3">
          <h3>決勝</h3>
          <div class="match" data-id="F">
            <span class="game-id">FINAL</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
        </div>

        <div class="round" data-round="3">
          <h3>3位決定戦</h3>
          <div class="match" data-id="T">
            <span class="game-id">Third</span>
            <button class="team-btn" data-slot="0"><span class="seed"></span><span class="name"></span></button>
            <button class="team-btn" data-slot="1"><span class="seed"></span><span class="name"></span></button>
          </div>
        </div>
      </div>

      <div class="result" id="result"></div>
    </div>
  </section>

  <script>
    // ==============================
    // データ定義
    // ==============================
    const bracketDef = {
      QF1: { next: { match: 'SF1', slot: 0 } },
      QF2: { next: { match: 'SF1', slot: 1 } },
      QF3: { next: { match: 'SF2', slot: 0 } },
      QF4: { next: { match: 'SF2', slot: 1 } },
      SF1: { next: { match: 'F', slot: 0 }, loserNext: { match: 'T', slot: 0 } },
      SF2: { next: { match: 'F', slot: 1 }, loserNext: { match: 'T', slot: 1 } },
      F:   {},
      T:   {},
    };

    // 状態: 各試合のチーム名と勝者（0/1）
    const state = new Map();
    ['QF1','QF2','QF3','QF4','SF1','SF2','F','T'].forEach(id=>{
      state.set(id, { teams:[{seed:'',name:''},{seed:'',name:''}], winner:null });
    });

    // 初期の8チーム（シード1〜8）
    let seeds = Array.from({length:8}, (_,i)=>({ seed: i+1, name: `チーム${i+1}` }));

    // ==============================
    // ユーティリティ
    // ==============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function setMatchTeam(matchId, slot, team){
      const m = state.get(matchId);
      m.teams[slot] = team ? { seed: team.seed??'', name: team.name??'' } : { seed:'', name:'' };
      // UI反映
      const el = document.querySelector(`.match[data-id="${matchId}"] .team-btn[data-slot="${slot}"]`);
      el.querySelector('.seed').textContent = m.teams[slot].seed ? `#${m.teams[slot].seed}` : '';
      el.querySelector('.name').textContent = m.teams[slot].name || '';
    }

    function clearWinnerCascade(matchId){
      // この試合の勝者ハイライト解除
      const m = state.get(matchId);
      m.winner = null;
      const matchEl = document.querySelector(`.match[data-id="${matchId}"]`);
      matchEl.querySelectorAll('.team-btn').forEach(btn=>btn.classList.remove('winner'));

      // 次ラウンドへの反映をクリア
      const def = bracketDef[matchId];
      if(def?.next){
        setMatchTeam(def.next.match, def.next.slot, {seed:'', name:''});
        clearWinnerCascade(def.next.match); // 以降も連鎖クリア
      }
      if(def?.loserNext){
        setMatchTeam(def.loserNext.match, def.loserNext.slot, {seed:'', name:''});
        clearWinnerCascade(def.loserNext.match);
      }
      updateResultBadges();
    }

    function setWinner(matchId, slot){
      const m = state.get(matchId);
      const def = bracketDef[matchId];

      // クリックで勝者決定 / Shift+クリックで取り消し
      if(slot === null){ // 取り消し
        clearWinnerCascade(matchId);
        return;
      }

      m.winner = slot;
      // 見た目ハイライト
      const matchEl = document.querySelector(`.match[data-id="${matchId}"]`);
      matchEl.querySelectorAll('.team-btn').forEach((btn,i)=>{
        btn.classList.toggle('winner', i===slot);
      });

      // 勝者を次ラウンドにセット
      if(def?.next){
        const team = m.teams[slot];
        setMatchTeam(def.next.match, def.next.slot, team);
        // 以降の勝者情報は不整合になる可能性があるのでクリア
        clearWinnerCascade(def.next.match);
      }

      // 準決勝の敗者を3決へ
      if(def?.loserNext){
        const loser = m.teams[1-slot];
        setMatchTeam(def.loserNext.match, def.loserNext.slot, loser);
        clearWinnerCascade(def.loserNext.match);
      }

      updateResultBadges();
    }

    function updateResultBadges(){
      const r = $('#result');
      const f = state.get('F');
      const t = state.get('T');
      r.innerHTML = '';
      if(f.winner!==null){
        const champ = f.teams[f.winner]?.name||'';
        const runner = f.teams[1-f.winner]?.name||'';
        if(champ) r.insertAdjacentHTML('beforeend', `<span class="pill">優勝: ${escapeHtml(champ)}</span>`);
        if(runner) r.insertAdjacentHTML('beforeend', `<span class="pill">準優勝: ${escapeHtml(runner)}</span>`);
      }
      if(t.winner!==null){
        const third = t.teams[t.winner]?.name||'';
        if(third) r.insertAdjacentHTML('beforeend', `<span class="pill">3位: ${escapeHtml(third)}</span>`);
      }
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
    }

    // ==============================
    // 初期描画 & 操作
    // ==============================
    function makeSeedInputs(){
      const wrap = $('#seedInputs');
      wrap.innerHTML = '';
      for(let i=0;i<8;i++){
        const label = document.createElement('label');
        label.textContent = `#${i+1}`;
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `チーム${i+1}`;
        input.value = seeds[i]?.name || '';
        input.dataset.index = String(i);
        wrap.appendChild(label); wrap.appendChild(input);
      }
    }

    function applySeeds(){
      // 入力値を seeds に反映
      $$('#seedInputs input').forEach(inp=>{
        const i = Number(inp.dataset.index);
        seeds[i].name = inp.value.trim() || `チーム${i+1}`;
      });
      // シングルエリミ 8枠の標準的な組み合わせ
      // QF1: 1 vs 8, QF2: 4 vs 5, QF3: 3 vs 6, QF4: 2 vs 7
      const pairs = [ [0,7], [3,4], [2,5], [1,6] ];
      ['QF1','QF2','QF3','QF4','SF1','SF2','F','T'].forEach(id=>{
        state.set(id, { teams:[{seed:'',name:''},{seed:'',name:''}], winner:null });
        const matchEl = document.querySelector(`.match[data-id="${id}"]`);
        matchEl.querySelectorAll('.team-btn').forEach(btn=>btn.classList.remove('winner'));
      });
      pairs.forEach((p,idx)=>{
        const a = { seed: seeds[p[0]].seed, name: seeds[p[0]].name };
        const b = { seed: seeds[p[1]].seed, name: seeds[p[1]].name };
        setMatchTeam(`QF${idx+1}`, 0, a);
        setMatchTeam(`QF${idx+1}`, 1, b);
      });
      drawLines();
      updateResultBadges();
    }

    function shuffleSeeds(){
      // フィッシャー–イェーツ
      for(let i=seeds.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [seeds[i],seeds[j]] = [seeds[j],seeds[i]];
      }
      // seed番号はそのまま、名前だけシャッフル
      makeSeedInputs();
    }

    function resetAll(){
      seeds = Array.from({length:8}, (_,i)=>({ seed: i+1, name: `チーム${i+1}` }));
      makeSeedInputs();
      applySeeds();
    }

    function wireMatchClicks(){
      $$('.match .team-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const slot = Number(btn.dataset.slot);
          const matchId = btn.closest('.match').dataset.id;
          if(e.shiftKey){ // 取り消し
            setWinner(matchId, null);
          } else {
            setWinner(matchId, slot);
          }
        });
      });
    }

    // ==============================
    // 接続線描画（SVG）
    // ==============================
    function drawLines(){
      const svg = $('#lines');
      // クリア
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      const box = $('#bracket').getBoundingClientRect();

      function midRight(el){
        const r = el.getBoundingClientRect();
        return { x: r.right - box.left, y: r.top - box.top + r.height/2 };
      }
      function midLeft(el){
        const r = el.getBoundingClientRect();
        return { x: r.left - box.left, y: r.top - box.top + r.height/2 };
      }
      function addPath(fromMatchId, toMatchId){
        const a = document.querySelector(`.match[data-id="${fromMatchId}"]`);
        const b = document.querySelector(`.match[data-id="${toMatchId}"]`);
        if(!a || !b) return;
        const p1 = midRight(a); const p2 = midLeft(b);
        const dx = Math.max(30, (p2.x - p1.x) * 0.5);
        const d = `M ${p1.x} ${p1.y} C ${p1.x+dx} ${p1.y}, ${p2.x-dx} ${p2.y}, ${p2.x} ${p2.y}`;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', d);
        svg.appendChild(path);
      }

      // 準々決勝→準決勝
      addPath('QF1','SF1');
      addPath('QF2','SF1');
      addPath('QF3','SF2');
      addPath('QF4','SF2');
      // 準決勝→決勝 & 3位決定戦
      addPath('SF1','F');
      addPath('SF2','F');
      addPath('SF1','T');
      addPath('SF2','T');

      // SVGサイズを親と同じに
      svg.setAttribute('width', Math.ceil(box.width));
      svg.setAttribute('height', Math.ceil(box.height));
      svg.setAttribute('viewBox', `0 0 ${Math.ceil(box.width)} ${Math.ceil(box.height)}`);
    }

    // ==============================
    // 初期化
    // ==============================
    window.addEventListener('resize', ()=> drawLines());

    document.addEventListener('DOMContentLoaded', ()=>{
      makeSeedInputs();
      wireMatchClicks();
      applySeeds();
      $('#applySeeds').addEventListener('click', applySeeds);
      $('#shuffleSeeds').addEventListener('click', shuffleSeeds);
      $('#resetAll').addEventListener('click', resetAll);
      setTimeout(drawLines, 0);
    });
  </script>
</body>
</html>
