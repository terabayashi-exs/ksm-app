# メール一括送信システム

## 概要

管理者が参加チームの代表者に対して、大会に関するお知らせをメールで一括送信できる機能です。Gmail SMTP（アプリパスワード）を使用し、スパム判定を回避するため1回の送信を最大5チームに制限しています。

## 📋 基本仕様

### アクセス制限
- **対象ユーザー**: 管理者のみ
- **アクセス方法**: 参加者管理画面 → 「メール送信」ボタン
- **画面遷移**: 別タブで開く（参加者管理画面を残したまま作業可能）

### 送信制限
| 項目 | 制限値 | 理由 |
|------|--------|------|
| 最大選択数（1回） | 5チーム | Gmail SMTPのスパム判定回避 |
| 実際の送信数 | 重複除去後 | 同じメールアドレスは1通のみ送信 |
| 1日の上限 | 2,000通 | Google Workspace制限 |
| 送信間隔 | 制限なし | 現状は手動送信のため |

### メール送信仕様

#### BCC一括送信モード（デフォルト）
- **送信元**: `rakusyogo-official@rakusyo-go.com`
- **宛先（TO）**: `rakusyogo-official@rakusyo-go.com`（送信記録用）
- **BCC**: 選択したチーム代表者のメールアドレス（重複除去済み）
- **プライバシー保護**: BCCを使用し、受信者間でメールアドレスを非公開
- **重複除去**: 複数チームが同じ代表者メールアドレスの場合、1通のみ送信

#### 個別送信モード（`{{teamName}}` 使用時）
- **送信元**: `rakusyogo-official@rakusyo-go.com`
- **宛先（TO）**: 各チーム代表者のメールアドレス（1通ずつ個別送信）
- **重複除去**: なし（同じメールアドレスでもチームごとに送信）
- **チーム名**: 各メールにチーム名が自動挿入される
- **用途**: 参加確定通知、辞退承認通知など、チーム特定が必要な場合

## 🎯 機能詳細

### 1. チーム選択機能

#### 選択可能なチーム
- **全ての参加チーム**（参加確定、キャンセル待ち、キャンセル済みなど全てを含む）
- **フィルタリング機能**（2025年12月19日追加）:
  - **参加ステータス**: すべて / 参加確定 / キャンセル待ち / キャンセル済み
  - **メール送信履歴**: すべて / 送信済み / 未送信（※申請受付（自動）は除外）

**設計理由**:
- 参加状態変更時に自動メール送信しない方針のため
- キャンセル済みチームへの連絡が必要なケースもあるため
- 大量のチームから必要なチームを素早く見つけるためのフィルタリング

#### チェックボックス制限
- 5チーム選択後、未選択のチェックボックスは自動的に無効化
- 5チーム目を選択しようとすると警告表示: `"一度に送信できるチーム数は5件までです"`
- 選択解除すると再度選択可能になる

#### 全選択機能
- 「最初の5件を選択」ボタンでチームリストの先頭5件を一括選択
- チーム数が5件以下の場合は全選択
- 6件以上の場合は先頭5件のみ選択し、アラート表示

### 2. メールテンプレート機能

#### プリセット一覧（データベース不要、コード内定義）

| ID | 名称 | 用途 |
|----|------|------|
| `custom` | カスタム（自由記述） | 完全に自由な内容 |
| `scheduleChange` | 試合日程変更のお知らせ | 日程変更時の通知 |
| `reminder` | 大会参加リマインド | 開催前のリマインダー |
| `importantNotice` | 重要なお知らせ | 重要事項の通知 |
| `thankYou` | 大会終了のお礼 | 大会終了後のお礼 |
| `participationConfirmed` | 参加確定通知（キャンセル待ちから繰り上げ） | 参加確定時の通知 |
| `withdrawalApproved` | 辞退申請承認通知 | 辞退承認時の通知 |

#### プリセットの構成
各プリセットには以下が含まれます：
- **タイトル**: メール件名（編集可能）
- **本文**: メール本文（編集可能）
- **プレースホルダー**:
  - `[ここに記載]` - 編集箇所を明示
  - `[URLをここに記載]` - **自動的に大会詳細URLに置換される**（例: `https://rakusyo-go.com/public/tournaments/123`）
  - `{{teamName}}` - **チーム名に置換される**（個別送信モード）

#### プリセット選択時の動作
1. ドロップダウンからプリセットを選択
2. タイトル・本文フィールドに自動入力
3. 内容を編集して送信（編集は任意）
4. 送信時に `[URLをここに記載]` が自動的に大会詳細URLに置換される

### 3. メール入力フォーム

#### 入力項目
| 項目 | 必須 | 制約 |
|------|------|------|
| テンプレート選択 | - | プリセットから選択 |
| メールタイトル | ✅ | 空白不可 |
| メール本文 | ✅ | 空白不可、改行保持、URL自動置換 |
| 大会運営者メールアドレス | - | 自動入力（編集可能）、お問い合わせ先として表示 |

#### バリデーション
- 送信ボタン押下時にチェック:
  - チーム未選択: `"送信先が未選択です。少なくとも1チームを選択してください"`
  - タイトルまたは本文が空: `"入力内容が不足しています。タイトルと本文を入力してください"`

### 4. メールプレビュー機能

タイトルと本文が両方入力されている場合、画面下部にプレビューを表示：
- **タイトル**: 太字・大きめフォント
- **本文**: 改行を保持して表示
- **大会名**: 自動的に追加表示（入力不要）

### 5. 送信確認ダイアログ

送信ボタン押下時、`window.confirm()` で確認：

```
3チームにメールを送信します。

タイトル: 【重要】試合日程変更のお知らせ

よろしいですか？
```

- **OK**: 送信処理実行
- **キャンセル**: 送信中止

### 6. 送信処理

#### 送信フロー

**BCC一括送信モード** （`{{teamName}}` なし）:
1. フロントエンド → API `/api/admin/tournaments/[id]/participants/email` へPOST
2. APIでバリデーション（認証、権限、5件制限、必須項目）
3. データベースからチーム情報取得
4. メールテンプレート生成（`generateCustomBroadcastEmail`）
5. BCC一括送信（重複除去）
6. 成功/失敗をフロントエンドに返却

**個別送信モード** （`{{teamName}}` あり）:
1. フロントエンド → API `/api/admin/tournaments/[id]/participants/email` へPOST
2. APIでバリデーション（認証、権限、5件制限、必須項目）
3. データベースからチーム情報取得
4. **各チームごとにループ処理**:
   - チーム名を `{{teamName}}` に置換
   - メールテンプレート生成
   - 個別に送信（TO直接指定）
5. 成功/失敗カウント・エラー詳細を返却

#### 成功時の動作
- アラート表示:
  - **BCC一括送信**:
    - 重複なし: `"メール送信成功: 3件のメールを送信しました"`
    - 重複あり: `"メール送信成功: 2件のメールアドレスに送信しました（3チーム選択、重複除去済み）"`
  - **個別送信**:
    - 全成功: `"メール送信成功: 3件のメールを個別に送信しました"`
    - 一部失敗: `"メール送信完了: 2/3件のメール送信に成功しました（一部失敗: 1件）"` + エラー詳細
- フォーム自動リセット:
  - チーム選択解除
  - プリセット「カスタム」に戻る
  - タイトル・本文クリア

#### 失敗時の動作
- エラーアラート表示: `"エラー: [エラーメッセージ]"`
- フォーム内容は保持（再送信可能）

## 🔧 技術仕様

### ファイル構成

```
lib/email/
├── mailer.ts                    # nodemailer設定、送信関数
└── templates-broadcast.ts       # カスタムメールテンプレート、プリセット定義

app/admin/tournaments/[id]/participants/
├── page.tsx                     # 参加者管理画面（メール送信ボタン追加）
└── email/
    └── page.tsx                 # メール送信画面（Client Component）

app/api/admin/tournaments/[id]/participants/email/
└── route.ts                     # メール送信APIエンドポイント
```

### 環境変数（`.env.local`）

```bash
# Gmail SMTP設定
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false                           # TLS使用（falseでポート587）
SMTP_USER=rakusyogo-official@rakusyo-go.com
SMTP_PASSWORD=xxxx xxxx xxxx xxxx           # Googleアプリパスワード（16桁）
SMTP_FROM_NAME=楽勝GO大会運営
SMTP_FROM_EMAIL=rakusyogo-official@rakusyo-go.com

# ベースURL（メール内リンク生成用）
NEXT_PUBLIC_BASE_URL=https://rakusyo-go.com  # 本番環境のURL
```

**重要**: Vercelにデプロイする場合、Vercel環境変数でも `NEXT_PUBLIC_BASE_URL` を設定してください。
- 開発環境: `http://localhost:3000`
- 本番環境: `https://rakusyo-go.com`（実際のドメイン）

### データベーステーブル

メール送信機能は既存のテーブルのみを使用（新規テーブル不要）：

- **`t_tournament_teams`**: 大会別チーム情報・参加状態取得
- **`m_teams`**: チーム名、代表者情報、メールアドレス取得
- **`m_administrators`**: 管理者メールアドレス取得（お問い合わせ先の自動入力用）

### メールテンプレート生成

#### `generateCustomBroadcastEmail()` パラメータ

```typescript
{
  title: string;           // メール件名
  body: string;            // メール本文（改行含む、[URLをここに記載]は自動置換）
  tournamentName?: string; // 大会名（オプション、フッターに表示）
  organizerEmail?: string; // 大会運営者メールアドレス（お問い合わせ先として表示）
  tournamentId?: number;   // 大会ID（URL自動生成用）
  baseUrl?: string;        // ベースURL（デフォルト: NEXT_PUBLIC_BASE_URL環境変数）
}
```

#### 出力形式

```typescript
{
  subject: string;  // メール件名
  text: string;     // プレーンテキスト版
  html: string;     // HTML版（スタイル付き）
}
```

#### HTMLテンプレートの特徴
- レスポンシブデザイン（最大幅600px）
- Googleフォント非依存（メール互換性重視）
- 青系グラデーションヘッダー
- 本文は `white-space: pre-wrap` で改行保持
- URL自動置換（`[URLをここに記載]` → 実際の大会詳細URL）
- お問い合わせ先フッター（organizerEmail指定時のみ表示）
- フッターに大会名・システム名を表示

### API仕様

#### エンドポイント
```
POST /api/admin/tournaments/[id]/participants/email
```

#### リクエストボディ

```typescript
{
  tournamentTeamIds: string[];   // 送信先tournament_team_id配列（最大5件）
  title: string;                 // メールタイトル
  body: string;                  // メール本文
  tournamentName?: string;       // 大会名（オプション）
  organizerEmail?: string;       // 大会運営者メールアドレス（オプション）
}
```

#### レスポンス（成功）

**BCC一括送信の場合**:
```json
{
  "success": true,
  "successCount": 2,
  "teamCount": 3,
  "message": "2件のメールアドレスに送信しました（3チーム選択、重複除去済み）"
}
```

**個別送信の場合**:
```json
{
  "success": true,
  "successCount": 3,
  "teamCount": 3,
  "message": "3件のメールを個別に送信しました",
  "errors": []
}
```

**個別送信で一部失敗の場合**:
```json
{
  "success": true,
  "successCount": 2,
  "teamCount": 3,
  "message": "2/3件のメール送信に成功しました（一部失敗: 1件）",
  "errors": ["チーム名A: SMTP connection failed"]
}
```

#### エラーレスポンス

| HTTPステータス | エラー内容 |
|---------------|-----------|
| 403 | 権限なし（管理者以外） |
| 400 | バリデーションエラー（送信先未指定、6件以上選択、必須項目不足） |
| 404 | 指定チームが見つからない |
| 500 | メール送信失敗（SMTP接続エラーなど） |

```json
{
  "error": "一度に送信できるチーム数は5件までです",
  "details": "詳細なエラーメッセージ"
}
```

## 📊 Gmail API制限と対応

### Google Workspace制限値

| 項目 | 制限値 |
|------|--------|
| 1日の送信数 | 2,000通 |
| 1通の最大宛先数（TO+CC+BCC合計） | 500件 |
| 推奨送信速度 | 約100通/分 |

### 本システムの対応

- **5件ずつ送信**: スパム判定回避、エラー影響範囲縮小
- **BCC使用**: プライバシー保護
- **自分宛にも送信**: 送信記録の保持

### 将来の拡張案（2,000通超え時）

#### 短期対応
1. **複数アカウント運用**: `rakusyogo-official2@rakusyo-go.com` など追加
2. **送信キュー**: 緊急度低いメールを翌日送信に回す

#### 中長期対応
- **外部サービス移行**: Resend（月3,000通無料）、SendGrid、AWS SES
- **マルチベンダー**: Gmail制限到達時に自動でResendにフォールバック

## 🎨 UI/UX仕様

### 画面レイアウト（2カラム）

```
┌─────────────────────────────────────────────────────┐
│ 📧 メール一括送信 - 富山県PK選手権大会2025          │
├─────────────────────────────────────────────────────┤
│ ⚠️ 送信制限について（注意事項ボックス）             │
├──────────────────────┬──────────────────────────────┤
│ 👥 送信先チーム選択   │ 📝 メール内容                │
│ 選択中: 2 / 5チーム   │ ┌─ テンプレート選択        │
│ ┌─📧 送信履歴の色分け │ ├─ メールタイトル          │
│ ├─🔍 フィルタリング   │ ├─ メール本文（大）        │
│ │  ├ 参加ステータス   │ ├─ 大会運営者メール        │
│ │  └ メール送信履歴   │ └─ 📤 送信ボタン           │
│ ├─☑ サンダーボルトFC │                             │
│ │  📧 参加確定通知    │                             │
│ ├─☑ レッドファルコンズ │                             │
│ │  📧 辞退承認通知    │                             │
│ ├─☐ ブルードラゴンズ  │                             │
│ └─☐ ゴールデンスターズ │                             │
├──────────────────────┴──────────────────────────────┤
│ ✅ プレビュー（タイトル・本文が両方入力時に表示）   │
└─────────────────────────────────────────────────────┘
```

### UI改善（2025年12月19日実装）

#### 送信履歴の色分け
- 🟢 **緑色**: 参加確定通知
- 🔴 **赤色**: 参加見送り通知・辞退承認通知
- 🟣 **紫色**: 辞退却下通知
- ⚫ **グレー**: その他（申請受付（自動）は非表示）

#### 文字サイズ拡大
- 凡例: `text-sm`
- チーム名: `text-base`（従来 `text-sm`）
- チーム情報: `text-sm`（従来 `text-xs`）
- フォームラベル: `text-sm font-medium`
- 入力フィールド: `text-base`、高さ `h-11`
- テキストエリア: `text-base leading-relaxed`
- プレビュータイトル: `text-xl`
- プレビュー本文: `text-base leading-relaxed`

### カラーテーマ
- **プライマリ**: 青系（`#2563eb`）
- **注意**: アンバー系（`#f59e0b`）
- **成功**: グリーン系（`#10b981`）

### レスポンシブ対応
- **PC（1024px以上）**: 2カラムレイアウト
- **タブレット・スマホ（1024px未満）**: 1カラム縦積み

## 🔐 セキュリティ

### 認証・認可
- NextAuth.js セッション検証
- 管理者ロール（`role === 'admin'`）のみアクセス可能
- セッション情報改ざん防止（JWT署名）

### 入力サニタイゼーション
- HTML生成時にテンプレートリテラルで自動エスケープ
- SQLインジェクション対策（プレースホルダー使用）

### SMTP認証
- Googleアプリパスワード使用（通常パスワード非使用）
- TLS暗号化（ポート587）

## 📝 運用ガイド

### メール送信手順

1. **準備**
   - 参加者管理画面で対象チームを確認
   - 送信内容を事前に整理

2. **送信**
   - 「メール送信」ボタンをクリック（別タブで開く）
   - 送信先チームを選択（最大5件）
   - テンプレート選択または自由記述
   - プレビューで内容確認
   - 「送信」ボタン → 確認ダイアログ → OK

3. **確認**
   - 成功メッセージ確認
   - 自分のメールボックス（`rakusyogo-official@rakusyo-go.com`）で送信メール確認

### トラブルシューティング

#### メール送信失敗
**症状**: エラーアラート表示
**原因**:
- SMTP設定ミス（`.env.local`の`SMTP_*`変数）
- アプリパスワード期限切れ
- ネットワーク接続エラー

**対処**:
1. `.env.local` の設定確認
2. Googleアカウントでアプリパスワード再発行
3. サーバー再起動: `npm run dev`

#### メールが届かない
**症状**: 送信成功だが受信者に届かない
**原因**:
- 受信者のスパムフィルタ
- メールアドレス誤り

**対処**:
1. 自分宛メールで送信記録確認
2. チーム情報のメールアドレス確認
3. 受信者にスパムフォルダ確認を依頼

#### 5件制限エラー
**症状**: 6件以上選択できない
**原因**: 仕様通りの動作（スパム判定回避）

**対処**:
1. 5件ずつ分割して送信
2. 緊急の場合は直接メールソフトから送信

### ベストプラクティス

#### 送信内容
- **件名**: 【重要】【リマインド】など種別を明示
- **本文**: 簡潔かつ具体的に記載
- **プレースホルダー**: `[ここに記載]` を実際の内容に置換

#### 送信タイミング
- **営業時間内**: 平日9:00-18:00を推奨
- **深夜避ける**: スパム判定リスク軽減
- **大量送信時**: 5件ずつ、10分間隔を推奨

#### 記録管理
- 自分宛メールをフォルダ分け（大会別、送信日別）
- 重要なメールは送信控えを別途保存

## 🔄 今後の拡張計画

### Phase 1（現在） - 完了
- ✅ 基本的なメール送信機能
- ✅ 7種類のプリセット（参加確定、辞退承認含む）
- ✅ 5チーム選択制限
- ✅ BCC方式
- ✅ メールアドレス重複除去
- ✅ URL自動置換（`[URLをここに記載]`）
- ✅ お問い合わせ先フッター（organizerEmail）
- ✅ 管理者メールアドレス自動入力
- ✅ フィルタリング機能（参加ステータス、送信履歴）
- ✅ 送信履歴の色分け表示
- ✅ UI/UX改善（文字サイズ拡大、凡例追加）
- ✅ 送信履歴の記録（`t_email_send_history` テーブル）

### Phase 2（将来）
- 送信予約機能（日時指定）
- 送信キュー（自動リトライ）
- 送信済みチームへの再送防止アラート

### Phase 3（将来）
- リッチテキストエディタ（太字、リンク挿入）
- 添付ファイル対応
- 外部メール配信サービス連携（Resend、SendGrid）
- 開封率・クリック率トラッキング

## 📚 関連ドキュメント

- [開発ガイド - メール設定](../guides/development.md)
- [アーキテクチャ設計 - メール配信](../specs/architecture.md)

---

**最終更新**: 2025年12月19日
**実装状態**: Phase 1完了（本番運用可能）

## 📝 更新履歴

### 2025年12月19日
- フィルタリング機能追加（参加ステータス、送信履歴）
- 送信履歴の色分け表示（緑:確定、赤:見送り/辞退承認、紫:却下）
- 送信履歴から申請受付（自動）を非表示に
- UI/UX改善（文字サイズ拡大、凡例追加、レイアウト改善）

### 2025年12月17日
- 送信履歴の記録機能実装（`t_email_send_history` テーブル）
- メール送信時に履歴を自動保存
