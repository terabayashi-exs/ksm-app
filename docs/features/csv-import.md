# CSV一括登録機能（管理者代行）

[← 実装済み機能一覧に戻る](./implemented-features.md)

## 📁 CSV一括登録機能（管理者代行）

### 基本概念

管理者が複数チームの情報をCSVファイルで一括登録し、各チームに仮パスワードを発行する機能です。大会運営の効率化とチーム登録の支援を目的としています。

### CSVファイル仕様

#### **フォーマット: マルチ行形式**
```csv
行種別,チーム名,略称,代表者名,メールアドレス,電話番号,選手名,背番号,ポジション
```

#### **行種別定義**
- `TEAM`: チーム基本情報行（選手情報カラムは空欄）
- `PLAYER`: 選手情報行（チーム情報カラムは空欄）
- `#`: コメント行（処理時に無視される）

#### **サンプルCSV**
```csv
行種別,チーム名,略称,代表者名,メールアドレス,電話番号,選手名,背番号,ポジション

TEAM,サンプルFC,サンプル,山田太郎,yamada@example.com,090-1234-5678,,,
PLAYER,,,,,,田中一郎,1,GK
PLAYER,,,,,,佐藤次郎,2,DF
PLAYER,,,,,,鈴木三郎,3,MF
PLAYER,,,,,,高橋四郎,,FW

TEAM,テストユナイテッド,テスト,鈴木花子,suzuki@example.com,080-9876-5432,,,
PLAYER,,,,,,中村太一,10,GK
PLAYER,,,,,,小林次郎,11,DF
PLAYER,,,,,,伊藤三郎,,MF
```

### 処理仕様

#### **バリデーション**
1. **必須項目チェック**: チーム名、略称、代表者名、メールアドレス、選手名
2. **形式チェック**: メールアドレス形式、背番号範囲（1-99）
3. **重複チェック**: チーム名・略称・メールアドレス、背番号（チーム内）
4. **制限チェック**: 選手数（1-20人）、列数（9列）

#### **登録処理**
1. **マスターチーム作成**: `m_teams`に登録（`registration_type = 'admin_proxy'`）
2. **選手マスター作成**: `m_players`に選手情報登録
3. **大会参加登録**: `t_tournament_teams`に参加エントリー
4. **参加選手登録**: `t_tournament_players`に選手割り当て
5. **仮パスワード発行**: 自動生成（`temp + 4桁ランダム`）

#### **エラーハンドリング**
- **行単位エラー表示**: 具体的なエラー内容と行番号
- **部分成功対応**: 成功チームと失敗チームの個別レポート
- **ロールバック**: チーム単位でのデータ整合性保証

### UI/UX設計

#### **3ステップワークフロー**
1. **CSVテンプレートダウンロード**: 形式説明付きテンプレート提供
2. **CSVファイルアップロード**: ドラッグ&ドロップ + ファイル選択
3. **プレビュー&一括登録**: エラーチェック + 登録実行

#### **視覚的フィードバック**
- 🔵 **ステップガイド**: 手順の明確化
- 🔴 **エラー表示**: 行番号付き詳細エラー
- 🟢 **プレビュー**: 登録前の内容確認
- 🟡 **結果レポート**: 成功/失敗の詳細表示

## 🔐 登録種別管理システム

### 基本概念

チーム代表者による自己登録と管理者による代行登録を区別し、適切な運用管理を可能にするシステムです。

### 実装仕様

#### **データベース設計**
```sql
-- m_teamsテーブル
registration_type TEXT DEFAULT 'self_registered'
-- 値: 'self_registered'（代表者登録）, 'admin_proxy'（管理者代行）
```

#### **区別表示**
- 🟢 **代表者登録**: 緑背景 + 「申し込み済み」ラベル
- 🟡 **管理者代行**: 黄背景 + 「管理者代行」ラベル + 説明アイコン

#### **運用メリット**
1. **パスワード管理**: 代行登録チームへの変更案内送信
2. **統計分析**: 登録方法別の分布データ
3. **セキュリティ**: 初期パスワード使用アカウントの特定

### 技術的実装

#### **自動設定**
- **チーム代表者登録**: `registration_type = 'self_registered'`（デフォルト）
- **管理者代行登録**: `registration_type = 'admin_proxy'`（API設定）
- **CSV一括登録**: `registration_type = 'admin_proxy'`（自動適用）

#### **クエリ例**
```sql
-- パスワード変更案内対象チーム
SELECT team_id, team_name, contact_email 
FROM m_teams 
WHERE registration_type = 'admin_proxy';

-- 登録方法別統計
SELECT registration_type, COUNT(*) as count
FROM m_teams 
GROUP BY registration_type;
```

