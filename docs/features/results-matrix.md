# 戦績表システムの実装仕様

[← 実装済み機能一覧に戻る](./implemented-features.md)

## 📊 戦績表システムの実装仕様

### 基本概念

戦績表は各チーム間の対戦結果をマトリックス形式で表示するシステムです。確定済みの試合は結果（勝敗・スコア）を表示し、未実施の試合は試合コードを表示することで、リーグ戦の進行状況を一目で把握できます。

### 主要ファイル

- **`components/features/tournament/TournamentResults.tsx`**: メインコンポーネント
- **`lib/match-results-calculator.ts`**: 戦績データ計算エンジン
- **`app/api/tournaments/[id]/results/route.ts`**: 戦績表データAPI

### 実装仕様

#### **1. データ構造**

```typescript
interface MatchMatrix {
  [teamId: string]: {
    [opponentId: string]: {
      result: 'win' | 'loss' | 'draw' | null;
      score: string; // "5〇4", "A1", "引き分け" など
      match_code: string;
    };
  };
}
```

#### **2. 表示ルール**

| 状態 | 表示内容 | 例 | 背景色 |
|------|----------|----|---------| 
| **確定済み勝利** | `〇\r\n勝利得点-敗北得点` | `〇\r\n5-4` | 白系 |
| **確定済み敗北** | `✕\r\n敗北得点-勝利得点` | `✕4-5` | 白系 |
| **確定済み引分** | `△\r\n得点-得点` | `△\r\n2-2` | 白系 |
| **不戦勝・不戦敗** | `不戦勝` / `不戦敗` | `不戦勝` | 緑系/赤系 |
| **未実施試合** | 試合コード | `A1`, `B3` | グレー系 |
| **同チーム** | ハイフン | `-` | ダークグレー |

#### **3. UI/UX設計**

##### **縦書きチーム名表示**
```tsx
// チーム略称を1文字ずつ縦に配置
{teamName.split('').map((char, index) => (
  <span key={index} className="block leading-tight">{char}</span>
))}
```

##### **レスポンシブ対応**
- 横スクロール対応（`overflow-x-auto`）
- 最小列幅設定（`min-w-[70px]`）
- モバイルでの読みやすさを考慮

##### **凡例システム**
- 勝利（〇）、敗北（●）、引分（△）の記号説明
- 未実施試合のコード表示例（A1）
- 色分けの説明

#### **4. データ取得・処理**

##### **SQLクエリ設計**
```sql
-- 確定済み + 未確定試合を取得
SELECT 
  ml.match_code,
  mf.team1_goals, mf.team2_goals,  -- 確定済み結果
  mf.winner_team_id, mf.is_draw,
  CASE WHEN mf.match_id IS NOT NULL THEN 1 ELSE 0 END as is_confirmed
FROM t_matches_live ml
LEFT JOIN t_matches_final mf ON ml.match_id = mf.match_id
WHERE ml.match_block_id = ? AND ml.team1_id IS NOT NULL
```

##### **マトリックス生成ロジック**
1. **初期化**: 全チーム組み合わせを`null`で初期化
2. **確定試合**: 結果とスコアを設定
3. **未確定試合**: 試合コードを設定
4. **安全性チェック**: 存在しないチームIDをスキップ

#### **5. 表示制限**

- **予選リーグのみ**: `phase === 'preliminary'`の試合のみ表示
- **決勝トーナメント**: 「リーグ戦形式ではないため表示されません」の注意書き
- **チーム数制限**: 10チーム程度まで推奨（表示幅の制約）

### 技術的考慮事項

#### **パフォーマンス**
- O(n²)のマトリックス構築（n=チーム数）
- 計算結果のキャッシュなし（リアルタイム更新優先）
- 大規模データでは要最適化

#### **データ整合性**
- 存在しないチームIDの安全な処理
- NULL値の適切なハンドリング
- フォールバック表示の実装

#### **ユーザビリティ**
- ツールチップでの詳細情報表示
- 視覚的な勝敗判別（記号・色分け）
- 未実施試合の進行状況把握

### 運用上の利点

1. **進行状況の可視化**: 各ブロックの試合消化状況が一目瞭然
2. **結果の迅速な確認**: マトリックス形式で対戦成績を素早く確認
3. **運営支援**: 未実施試合の識別と進行管理
4. **観戦者への情報提供**: 分かりやすい結果表示

