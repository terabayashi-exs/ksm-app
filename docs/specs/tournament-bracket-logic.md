# トーナメント表描画ロジック仕様書

## 概要

可変チーム数に対応したトーナメントブラケットの構造計算・描画ロジックを定義する。

## 設計思想: 8チームブロック単位

### コアコンセプト

**8チームを1ブロックの基本単位**として設計する。

- 各ブロックには1〜8チームが存在
- ブロック内の描画パターンは8通りのみ
- 大規模トーナメントはブロックの組み合わせで実現

```
┌─────────────────────────────────────────────────────┐
│  トーナメント全体 = ブロック × N + ブロック間接続    │
│                                                     │
│  ブロック: 1-8チームの小トーナメント（8パターン）    │
│  接続: ブロック勝者同士の準決勝・決勝               │
└─────────────────────────────────────────────────────┘
```

### ブロック数の決定

| 総チーム数 | ブロック数 | 各ブロックのチーム数例        |
|-----------|-----------|------------------------------|
| 1-8       | 1         | そのまま                      |
| 9-16      | 2         | 4+5, 5+5, 8+8 など           |
| 17-32     | 4         | 4+4+4+5, 8+8+8+8 など        |
| 33-64     | 8         | 各ブロック4-8チーム          |

---

## ブロック内パターン（1-8チーム）

### パターン一覧

| パターン | チーム数 | 山配分 | 1回戦 | 準決勝 | 決勝 | 総試合数 | シード数 |
|---------|---------|-------|------|-------|-----|---------|---------|
| P1      | 1       | -     | -    | -     | -   | -       | **未対応** |
| P2      | 2       | 1+1   | 0    | 0     | 1   | 1       | 0       |
| P3      | 3       | 1+2   | 1    | 0     | 1   | 2       | 1       |
| P4      | 4       | 2+2   | 0    | 2     | 1   | 3       | 0       |
| P5      | 5       | 2+3   | 1    | 2     | 1   | 4       | 1       |
| P6      | 6       | 3+3   | 2    | 2     | 1   | 5       | 2       |
| P7      | 7       | 3+4   | 3    | 2     | 1   | 6       | 1       |
| P8      | 8       | 4+4   | 4    | 2     | 1   | 7       | 0       |

> **注意**: P1（1チームのみ）は実用上不要のため未対応。試合数0を渡すとエラーになる。

### 各パターンの構造図

#### P1: 1チーム（未対応）

> 1チームのみのケースは実用上不要のため未対応。

#### P2: 2チーム（決勝のみ）
```
[チーム1] ─┐
           ├─→ 勝者
[チーム2] ─┘
```

#### P3: 3チーム（1+2配分）
```
[チーム1] シード ──┐
                   ├─→ 勝者
[チーム2] ─┐       │
           ├───────┘
[チーム3] ─┘
```

> チーム1はシード（不戦勝）として1回戦カラムに表示される。

#### P4: 4チーム（2+2配分、準決勝から）
```
[チーム1] ─┐
           ├─ SF1 ─┐
[チーム2] ─┘       │
                   ├─→ 勝者
[チーム3] ─┐       │
           ├─ SF2 ─┘
[チーム4] ─┘
```

#### P5: 5チーム（2+3配分）
```
[チーム1] シード ─ SF1 ─┐
                        │
                        ├─→ 勝者
[チーム2] ─────┐        │
               ├─ SF2 ──┘
[チーム3] ─┐   │
           ├───┘
[チーム4] ─┘
```

> チーム1はシード（不戦勝）として1回戦カラムに表示される。

#### P6: 6チーム（3+3配分）
```
[チーム1] シード ──┐
                   ├─ SF1 ─┐
[チーム2] ─┐       │       │
           ├───────┘       │
[チーム3] ─┘               ├─→ 勝者
                           │
[チーム4] ─┐               │
           ├───────┐       │
[チーム5] ─┘       ├─ SF2 ─┘
                   │
[チーム6] シード ──┘
```

> チーム1とチーム6はシード（不戦勝）として1回戦カラムに表示される。

#### P7: 7チーム（3+4配分）
```
[チーム1] シード ──┐
                   ├─ SF1 ─┐
[チーム2] ─┐       │       │
           ├───────┘       │
[チーム3] ─┘               ├─→ 勝者
                           │
[チーム4] ─┐               │
           ├───┐           │
[チーム5] ─┘   ├─ SF2 ─────┘
               │
[チーム6] ─┐   │
           ├───┘
[チーム7] ─┘
```

> チーム1はシード（不戦勝）として1回戦カラムに表示される。

#### P8: 8チーム（4+4配分、現行システム）
```
[チーム1] ─┐
           ├─ QF1 ─┐
[チーム2] ─┘       │
                   ├─ SF1 ─┐
[チーム3] ─┐       │       │
           ├─ QF2 ─┘       │
[チーム4] ─┘               ├─→ 勝者
                           │
[チーム5] ─┐               │
           ├─ QF3 ─┐       │
[チーム6] ─┘       │       │
                   ├─ SF2 ─┘
[チーム7] ─┐       │
           ├─ QF4 ─┘
[チーム8] ─┘
```

---

## ブロックの組み合わせ（9チーム以上）

### 設計方針

- **描画に特化**: 勝敗ロジックはトーナメント表に持たせない
- **ブロックは最大3ステップ**: 1回戦→準決勝→決勝相当
- **再帰的構造**: ブロックの勝者を集めて新しいブロックを作成

### レイアウト方針

- **水平方向は最大3ステップ**（1回戦→準決勝→決勝相当）
- **ブロックは縦方向（下）に追加していく**
- 決勝ブロックも下に配置（右に伸ばさない）

### 2ブロック構成（9-16チーム）

```
┌─────────────────────────────────────────┐
│                Block A                  │
│              (4-8チーム)                 │
│         [最大3ステップで描画]            │
│                    → 勝者A              │
└─────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────┐
│                Block B                  │
│              (4-8チーム)                 │
│         [最大3ステップで描画]            │
│                    → 勝者B              │
└─────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────┐
│             決勝ブロック                 │
│    勝者A vs 勝者B（P2パターンで描画）     │
└─────────────────────────────────────────┘
```

### 4ブロック構成（17-32チーム）

```
┌─────────────────────────────────────────┐
│                Block A → 勝者A          │
└─────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────┐
│                Block B → 勝者B          │
└─────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────┐
│                Block C → 勝者C          │
└─────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────┐
│                Block D → 勝者D          │
└─────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────┐
│             決勝ブロック                 │
│  勝者A,B,C,D（P4パターンで描画）         │
└─────────────────────────────────────────┘
```

### 8ブロック構成（33-64チーム）

- Block A〜H を縦に配置
- 最後に決勝ブロック（P8パターン）を下に追加

### チーム配分例

| 総チーム数 | ブロック数 | 配分例 | 決勝ブロック |
|-----------|-----------|--------|-------------|
| 9         | 2         | 4+5    | P2          |
| 12        | 2         | 6+6    | P2          |
| 16        | 2         | 8+8    | P2          |
| 17        | 4         | 4+4+4+5 | P4         |
| 24        | 4         | 6+6+6+6 | P4         |
| 32        | 4         | 8+8+8+8 | P4         |
| 33        | 8         | 4×7+5  | P8          |
| 64        | 8         | 8×8    | P8          |

---

## 統合ブロック対応（2026年2月実装）

### 概要

トーナメント形式の大会では、複数の予選ブロック（A, B, C, D）を`preliminary_unified`という統合ブロックで管理する。
しかし、画面表示では各ブロックを個別に表示する必要がある。

### 問題と解決策

#### 問題
- データベースでは全ブロックが1つの`match_block_id`にまとめられている
- 試合の`match_code`は`A1`, `A2`, `B1`, `B2`のようにブロックプレフィックス付き
- 従来のコードは単一ブロックのみ想定していた

#### 解決策（TournamentBracket.tsx）

```typescript
// 1. match_codeからブロック名を抽出
const blockMap = new Map<string, BracketMatch[]>();
mainMatches.forEach((match) => {
  let blockName = match.block_name || "main";

  // 統合ブロックの場合は、match_codeの先頭文字をブロック名として使用
  if (blockName === 'preliminary_unified' || blockName === 'final_unified') {
    const matchCodePrefix = match.match_code.match(/^([A-Z])/);
    if (matchCodePrefix) {
      blockName = matchCodePrefix[1]; // "A", "B", "C", etc.
    }
  }

  if (!blockMap.has(blockName)) {
    blockMap.set(blockName, []);
  }
  blockMap.get(blockName)!.push(match);
});

// 2. MultiBlockBracketの使用条件
const hasLargeBlock = blockData.some(block => block.matches.length >= 8);
const shouldUseMultiBlock = blockData.length >= 2 || hasLargeBlock;
```

### 重複ブロック作成の防止（create-new/route.ts）

#### 問題
統合ブロックの作成時、`blockMap`に統合ブロックキー自体を登録していなかったため、
ループ内で重複して作成されていた。

#### 解決策

```typescript
const unifiedBlockId = Number(blockResult.lastInsertRowid);

// 統合ブロックキー自体をblockMapに登録（重複作成防止）
blockMap.set(unifiedBlockKey, unifiedBlockId);

// 同じフェーズの全ブロックを統合ブロックにマッピング
Array.from(uniqueBlocks)
  .filter(key => key.startsWith(`${phase}_`))
  .forEach(key => {
    blockMap.set(key, unifiedBlockId);
  });
```

### 順位表の形式別表示（TournamentStandings.tsx）

#### トーナメント形式の特徴
- 試合数（matches_played）がカウントされない
- 順位は試合結果から自動計算

#### 修正内容

```typescript
// トーナメント形式では試合数チェックをスキップ
<span className="font-bold text-base md:text-lg">
  {isTournamentFormat(block.phase) ? (
    team.position > 0 ? team.position : '-'
  ) : (
    team.matches_played === 0 ? '-' : team.position
  )}
</span>
```

### 手動順位設定画面のブロック名表示

#### 修正前
- `preliminary_unified` → "予選preliminary_unifiedブロック"（冗長）

#### 修正後
- `preliminary_unified` → "予選トーナメント"
- `A`, `B`, `C` → "予選Aブロック", "予選Bブロック", ...

```typescript
{(() => {
  if (block.phase === 'preliminary') {
    return block.block_name === 'preliminary_unified'
      ? '予選トーナメント'
      : `予選${block.block_name}ブロック`;
  }
  return block.display_round_name;
})()}
```

---

## 描画仕様

### レイアウト

- 左から右へ進行（1回戦 → 決勝）
- 各ラウンドは1カラム
- カード間の接続線はSVGで描画
- 後続ラウンドのカードは、前ラウンドの対応するカード群の**中央**に配置する
